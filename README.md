# dominion

Domain middleware for Express and vanilla Node.js. Dominion has no production dependencies.

Dominion will attempt to gracefully close all servers registered with it when any requests using
the domain middleware throw an otherwise uncaught exception.

## Usage

Dominion provides both a middleware function and a function to add server instances. Dominion is
slightly atypical in that it requires references to all server instances that a worker is running.
This middleware must only be used on cluster worker processes. Cluster and domain are two sides of
the same coin, so this should be no surprise.

```javascript
var dominion = require('dominion');
var express = require('express');

var app = express();

// Add at the beginning of the middleware chain.
app.use(dominion.middleware);

// Add other middleware and routes...

// The server object is returned from `app.listen`.
var server = app.listen(3000, function () {
    console.log('Server listening.');
});

// Register the server object with dominion. This is required!
dominion.addServer(server);

// Give dominion a chance to finish its job, but avoid hangs.
dominion.once('shutdown', function () {
    var killtimer = setTimeout(function () {
        process.exit(1);
    }, 5000);

    killtimer.unref();
});
```

To use with vanilla Node HTTP servers, you can spoof the `next` function with a function of your
own:

```javascript
var http = require('http');
var dominion = require('dominion');

// Give dominion a chance to finish its job, but avoid hangs.
dominion.once('shutdown', function () {
    var killtimer = setTimeout(function () {
        process.exit(1);
    }, 5000);

    killtimer.unref();
});


// Create a server.
var server = http.createServer(function (req, res) {
    'use strict';

    dominion.middleware(req, res, function (err) {
        // Handle errors and the rest of your handler logic.
    });
});

// Register the server with dominion.
dominion.addServer(server);

server.listen(3000);
```

You should register all servers with dominion. If any exceptions are generated by a request or a
response, then all registered servers are closed to stop new incoming connections. You should
register a listener on the `'shutdown'` event to for the server to close after some time, in case
the server hangs.

## Events

Events for logging and shutdown are emitted by dominion. It is assumed that you'll have your own
logging solution.

### `shutdown`

Emitted when the domain inside the middleware catches an error. You should register a listener on
this event to set a timeout to force the process to close if it is hung for whatever reason.

### `domainError`

Emitted when the domain is handling the error. It passes the request, response and error objects
respectively to the event listener for logging.

### `sendError`

If there was an error in the shutdown process in the domain middleware, then this event is emitted,
and passes the request, response and error objects respectively to the listener.
